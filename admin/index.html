<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¨“ç·´ç®¡ç†å¾Œå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .tabs { display: flex; background: white; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .tab { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: #007acc; background: #f8f9fa; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 0 8px 8px; }
        .tab-content.active { display: block; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .image-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; transition: transform 0.2s; }
        .image-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .image-card img { width: 100%; height: 250px; object-fit: cover; border-bottom: 1px solid #eee; }
        .image-info { padding: 15px; }
        .label-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .label-btn { padding: 8px 5px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 4px; font-size: 12px; }
        .label-btn:hover { background: #e9ecef; }
        .label-btn.selected { background: #007acc; color: white; border-color: #007acc; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; border: 1px solid #e9ecef; }
        .training-controls { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .btn { padding: 10px 20px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; align-items: center; }
        .pagination { display: flex; justify-content: center; margin: 20px 0; gap: 10px; }
        .page-btn { padding: 8px 15px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .page-btn.active { background: #007acc; color: white; border-color: #007acc; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: #28a745; transition: width 0.3s; }
        .batch-controls { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§  AI åœ–ç‰‡åˆ†é¡è¨“ç·´ç³»çµ±</h1>
            <p>æ¨™è¨˜åœ–ç‰‡è¨“ç·´ AI æ¨¡å‹ï¼Œæé«˜åˆ†é¡æº–ç¢ºåº¦ - æ”¯æŒæ‰¹é‡è™•ç† 3000+ åœ–ç‰‡</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('labeling')">ğŸ·ï¸ åœ–ç‰‡æ¨™è¨˜</div>
            <div class="tab" onclick="showTab('training')">ğŸ¯ æ¨¡å‹è¨“ç·´</div>
            <div class="tab" onclick="showTab('stats')">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</div>
        </div>

        <!-- åœ–ç‰‡æ¨™è¨˜ç•Œé¢ -->
        <div class="tab-content active" id="labeling">
            <h2>ğŸ“¸ åœ–ç‰‡æ¨™è¨˜å·¥å…· (3000+ åœ–ç‰‡)</h2>
            
            <div class="controls">
                <button class="btn" onclick="loadUnlabeledImages()">è¼‰å…¥åœ–ç‰‡</button>
                <button class="btn btn-success" onclick="testImagePaths()">æ¸¬è©¦åœ–ç‰‡è·¯å¾‘</button>
                <button class="btn btn-warning" onclick="debugCurrentLabels()">èª¿è©¦ä¿¡æ¯</button>
                
                <select id="batchSize" onchange="loadUnlabeledImages()">
                    <option value="12">æ¯æ¬¡ 12 å¼µ</option>
                    <option value="24" selected>æ¯æ¬¡ 24 å¼µ</option>
                    <option value="36">æ¯æ¬¡ 36 å¼µ</option>
                    <option value="48">æ¯æ¬¡ 48 å¼µ</option>
                </select>
                
                <span>å·²æ¨™è¨˜: <span id="labeledCount">0</span> å¼µ</span>
                <span>å‰©é¤˜: <span id="remainingCount">?</span> å¼µ</span>
            </div>

            <div class="batch-controls">
                <strong>æ‰¹é‡æ“ä½œ:</strong>
                <button class="btn" onclick="markAllAsOther()">æ¨™è¨˜æœ¬é ç‚º"å…¶ä»–"</button>
                <button class="btn" onclick="clearCurrentLabels()">æ¸…é™¤é¸æ“‡</button>
            </div>

            <div class="pagination" id="pagination">
                <!-- åˆ†é æŒ‰éˆ•æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="labelProgress" style="width: 0%"></div>
            </div>

            <div class="image-grid" id="unlabeledImages">
                <p>é»æ“Š"è¼‰å…¥åœ–ç‰‡"é–‹å§‹æ¨™è¨˜...</p>
            </div>

            <div class="pagination" id="paginationBottom">
                <!-- åº•éƒ¨åˆ†é æŒ‰éˆ• -->
            </div>
        </div>

        <!-- æ¨¡å‹è¨“ç·´ç•Œé¢ -->
        <div class="tab-content" id="training">
            <h2>ğŸ¯ æ¨¡å‹è¨“ç·´æ§åˆ¶å°</h2>
            <div class="training-controls">
                <div>
                    <label><strong>è¨“ç·´è¼ªæ¬¡:</strong> </label>
                    <input type="number" id="epochs" value="10" min="1" max="100">
                    <button class="btn" onclick="startTraining()">é–‹å§‹è¨“ç·´</button>
                </div>
                <div style="margin-top: 15px;">
                    <label><strong>å·²æ¨™è¨˜æ•¸æ“š:</strong> </label>
                    <span id="trainingStats">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            <div id="trainingProgress">
                <p>é»æ“Š"é–‹å§‹è¨“ç·´"ä¾†è¨“ç·´ AI æ¨¡å‹</p>
            </div>
        </div>

        <!-- æ•¸æ“šçµ±è¨ˆç•Œé¢ -->
        <div class="tab-content" id="stats">
            <h2>ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h2>
            <div class="stats-grid" id="statsGrid">
                <p>è¼‰å…¥çµ±è¨ˆæ•¸æ“šä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        let currentLabels = {};
        let currentPage = 1;
        let totalPages = 1;
        let currentImages = [];
        const ITEMS_PER_PAGE = 24;

        // é¡¯ç¤ºæ¨™ç±¤é 
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'stats') {
                loadStats();
            } else if (tabName === 'training') {
                loadTrainingStats();
            } else if (tabName === 'labeling') {
                loadUnlabeledImages();
            }
        }

        // è¼‰å…¥æœªæ¨™è¨˜çš„åœ–ç‰‡
        async function loadUnlabeledImages() {
            try {
                const container = document.getElementById('unlabeledImages');
                const batchSize = document.getElementById('batchSize').value;
                container.innerHTML = '<p>è¼‰å…¥åœ–ç‰‡ä¸­...</p>';
                
                const response = await fetch(`/api/unlabeled-images?limit=${batchSize}&page=${currentPage}`);
                const data = await response.json();
                
                console.log('æ”¶åˆ°çš„åœ–ç‰‡æ•¸æ“š:', data);
                
                if (!data.images || data.images.length === 0) {
                    container.innerHTML = '<p>æ²’æœ‰æ‰¾åˆ°æœªæ¨™è¨˜çš„åœ–ç‰‡ï¼Œæˆ–è€…æ‰€æœ‰åœ–ç‰‡éƒ½å·²æ¨™è¨˜å®Œæˆï¼</p>';
                    updatePagination(0, 0);
                    return;
                }
                
                currentImages = data.images;
                totalPages = Math.ceil(data.total / batchSize);
                
                displayImages(data.images);
                updatePagination(data.total, data.labeledCount);
                updateProgress(data.labeledCount, data.total);
                
            } catch (error) {
                console.error('è¼‰å…¥åœ–ç‰‡å¤±æ•—:', error);
                document.getElementById('unlabeledImages').innerHTML = 
                    `<p style="color: red;">è¼‰å…¥åœ–ç‰‡å¤±æ•—: ${error.message}</p>`;
            }
        }

        // é¡¯ç¤ºåœ–ç‰‡
        function displayImages(images) {
            const container = document.getElementById('unlabeledImages');
            
            container.innerHTML = images.map(image => {
                const imageUrl = image.image_url || `/data/raw/${image.display_name}`;
                const fileName = image.display_name || image.file_name || 'æœªçŸ¥æ–‡ä»¶';
                
                // å®‰å…¨åœ°è™•ç†è·¯å¾‘ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å•é¡Œ
                const safePath = encodeURIComponent(image.file_path);
                
                return `
                    <div class="image-card" data-path="${safePath}">
                        <img src="${imageUrl}" alt="${fileName}" 
                             onerror="handleImageError(this, '${fileName.replace(/'/g, "\\'")}')"
                             loading="lazy">
                        <div class="image-info">
                            <div><strong>æ–‡ä»¶:</strong> ${fileName}</div>
                            <div class="label-buttons">
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'basketball')">ğŸ€ ç±ƒçƒ</button>
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'soccer')">âš½ è¶³çƒ</button>
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'tennis')">ğŸ¾ ç¶²çƒ</button>
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'baseball')">âš¾ æ£’çƒ</button>
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'swimming')">ğŸŠ æ¸¸æ³³</button>
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'running')">ğŸƒ è·‘æ­¥</button>
                                <button class="label-btn" onclick="selectLabel('${safePath}', 'other')">â“ å…¶ä»–</button>
                            </div>
                            <button class="btn" onclick="submitLabel('${safePath}')" style="margin-top: 10px; width: 100%;">ç¢ºèªæ¨™è¨˜</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°åˆ†é 
        function updatePagination(total, labeled) {
            document.getElementById('labeledCount').textContent = labeled;
            document.getElementById('remainingCount').textContent = total - labeled;
            
            const pagination = document.getElementById('pagination');
            const paginationBottom = document.getElementById('paginationBottom');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                paginationBottom.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é 
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é </button>`;
            }
            
            // é ç¢¼
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<span class="page-btn" style="background: transparent; border: none;">...</span>`;
                }
            }
            
            // ä¸‹ä¸€é 
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é </button>`;
            }
            
            pagination.innerHTML = paginationHTML;
            paginationBottom.innerHTML = paginationHTML;
        }

        // æ›é 
        function changePage(page) {
            currentPage = page;
            loadUnlabeledImages();
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(labeled, total) {
            const progress = document.getElementById('labelProgress');
            const percentage = total > 0 ? (labeled / total) * 100 : 0;
            progress.style.width = `${percentage}%`;
        }

        // é¸æ“‡æ¨™ç±¤
        function selectLabel(imagePath, sportType) {
            const decodedPath = decodeURIComponent(imagePath);
            console.log('é¸æ“‡æ¨™ç±¤:', decodedPath, sportType);
            
            // é‡ç½®ç•¶å‰åœ–ç‰‡çš„æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹
            const card = event.target.closest('.image-card');
            if (card) {
                card.querySelectorAll('.label-btn').forEach(btn => btn.classList.remove('selected'));
                
                // è¨­ç½®ç•¶å‰é¸æ“‡
                currentLabels[decodedPath] = sportType;
                
                // é«˜äº®é¸æ“‡çš„æŒ‰éˆ•
                event.target.classList.add('selected');
            }
        }

        // æäº¤æ¨™ç±¤
        async function submitLabel(imagePath) {
            const decodedPath = decodeURIComponent(imagePath);
            const sportType = currentLabels[decodedPath];
            
            if (!sportType) {
                showMessage('è«‹å…ˆé¸æ“‡é‹å‹•é¡å‹', 'error');
                return;
            }

            try {
                console.log('ğŸš€ ç™¼é€æ¨™è¨˜è«‹æ±‚:', { imagePath: decodedPath, sportType });
                
                const response = await fetch('/api/label-image', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        imagePath: decodedPath,
                        sportType: sportType 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('ğŸ“¨ æœå‹™å™¨éŸ¿æ‡‰:', result);
                
                if (result.success) {
                    removeImageCard(imagePath);
                    delete currentLabels[decodedPath];
                    
                    showMessage(`âœ… æ¨™è¨˜æˆåŠŸ: ${sportType}`, 'success');
                    
                    // é‡æ–°åŠ è¼‰ç•¶å‰é é¢ä»¥æ›´æ–°çµ±è¨ˆ
                    setTimeout(() => loadUnlabeledImages(), 1000);
                } else {
                    throw new Error(result.error || 'æ¨™è¨˜å¤±æ•—');
                }
            } catch (error) {
                console.error('âŒ æ¨™è¨˜å¤±æ•—:', error);
                showMessage('æ¨™è¨˜å¤±æ•—: ' + error.message, 'error');
            }
        }

        // å®‰å…¨åœ°ç§»é™¤åœ–ç‰‡å¡ç‰‡
        function removeImageCard(encodedPath) {
            const card = document.querySelector(`[data-path="${encodedPath}"]`);
            if (card) {
                card.style.opacity = '0.5';
                setTimeout(() => card.remove(), 500);
            }
        }

        // æ‰¹é‡æ¨™è¨˜ç‚º"å…¶ä»–"
        function markAllAsOther() {
            const cards = document.querySelectorAll('.image-card');
            cards.forEach(card => {
                const path = card.getAttribute('data-path');
                currentLabels[decodeURIComponent(path)] = 'other';
                
                // æ›´æ–°UI
                card.querySelectorAll('.label-btn').forEach(btn => {
                    btn.classList.remove('selected');
                    if (btn.textContent.includes('å…¶ä»–')) {
                        btn.classList.add('selected');
                    }
                });
            });
            showMessage('å·²æ¨™è¨˜æœ¬é æ‰€æœ‰åœ–ç‰‡ç‚º"å…¶ä»–"', 'success');
        }

        // æ¸…é™¤ç•¶å‰é¸æ“‡
        function clearCurrentLabels() {
            currentLabels = {};
            document.querySelectorAll('.label-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            showMessage('å·²æ¸…é™¤æ‰€æœ‰é¸æ“‡', 'info');
        }

        // é–‹å§‹è¨“ç·´
        async function startTraining() {
            const epochs = document.getElementById('epochs').value;
            const progress = document.getElementById('trainingProgress');
            
            progress.innerHTML = '<p>ğŸ”„ é–‹å§‹è¨“ç·´æ¨¡å‹...</p>';
            
            try {
                const response = await fetch('/api/train-model', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ epochs: parseInt(epochs) })
                });

                const result = await response.json();
                if (result.success) {
                    progress.innerHTML = `
                        <p style="color: green;">âœ… è¨“ç·´å®Œæˆï¼</p>
                        <p>æœ€çµ‚æº–ç¢ºåº¦: ${result.history.acc[result.history.acc.length - 1].toFixed(4)}</p>
                        <p>æœ€çµ‚æå¤±: ${result.history.loss[result.history.loss.length - 1].toFixed(4)}</p>
                    `;
                    showMessage('æ¨¡å‹è¨“ç·´å®Œæˆï¼', 'success');
                } else {
                    throw new Error(result.error || 'è¨“ç·´å¤±æ•—');
                }
            } catch (error) {
                console.error('è¨“ç·´å¤±æ•—:', error);
                progress.innerHTML = `<p style="color: red;">âŒ è¨“ç·´éŒ¯èª¤: ${error.message}</p>`;
                showMessage('è¨“ç·´å¤±æ•—: ' + error.message, 'error');
            }
        }

        // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>ç¸½åœ–ç‰‡æ•¸</h3>
                        <div style="font-size: 2em;">${stats.totalImages}</div>
                    </div>
                    <div class="stat-card">
                        <h3>å·²æ¨™è¨˜åœ–ç‰‡</h3>
                        <div style="font-size: 2em;">${stats.totalLabeled}</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ¸…ç†å¾Œåœ–ç‰‡</h3>
                        <div style="font-size: 2em;">${stats.cleanedImages}</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ¨™è¨˜é€²åº¦</h3>
                        <div style="font-size: 2em;">${stats.totalImages > 0 ? ((stats.totalLabeled / stats.totalImages) * 100).toFixed(1) : 0}%</div>
                    </div>
                    ${Object.entries(stats.labeled).map(([sport, count]) => `
                        <div class="stat-card">
                            <h3>${sport}</h3>
                            <div style="font-size: 1.5em;">${count}</div>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                document.getElementById('statsGrid').innerHTML = 
                    `<p style="color: red;">è¼‰å…¥çµ±è¨ˆå¤±æ•—: ${error.message}</p>`;
            }
        }

        // è¼‰å…¥è¨“ç·´çµ±è¨ˆ
        async function loadTrainingStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                document.getElementById('trainingStats').textContent = 
                    `${stats.totalLabeled} å¼µå·²æ¨™è¨˜åœ–ç‰‡`;
            } catch (error) {
                document.getElementById('trainingStats').textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }

        // æ¸¬è©¦åœ–ç‰‡è·¯å¾‘
        async function testImagePaths() {
            try {
                const response = await fetch('/api/test-images');
                const result = await response.json();
                console.log('æ¸¬è©¦çµæœ:', result);
                
                let message = `æ‰¾åˆ° ${result.images.length} å€‹æ¸¬è©¦åœ–ç‰‡:\n`;
                result.images.forEach(img => {
                    message += `\nâ€¢ ${img.name} -> ${img.url}`;
                });
                
                alert(message);
            } catch (error) {
                console.error('æ¸¬è©¦å¤±æ•—:', error);
                alert('æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }

        // èª¿è©¦ä¿¡æ¯
        function debugCurrentLabels() {
            console.log('ç•¶å‰æ¨™è¨˜ç‹€æ…‹:', currentLabels);
            console.log('åœ–ç‰‡å¡ç‰‡æ•¸é‡:', document.querySelectorAll('.image-card').length);
            console.log('ç•¶å‰é ç¢¼:', currentPage, 'ç¸½é æ•¸:', totalPages);
            
            const cards = document.querySelectorAll('.image-card');
            cards.forEach((card, index) => {
                console.log(`å¡ç‰‡ ${index}:`, card.getAttribute('data-path'));
            });
            
            showMessage('èª¿è©¦ä¿¡æ¯å·²è¼¸å‡ºåˆ°æ§åˆ¶å°', 'info');
        }

        // è™•ç†åœ–ç‰‡åŠ è¼‰éŒ¯èª¤
        function handleImageError(img, fileName) {
            console.log('åœ–ç‰‡åŠ è¼‰å¤±æ•—:', fileName, 'URL:', img.src);
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjI1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
        }

        // é¡¯ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
            alert(`[${type.toUpperCase()}] ${message}`);
        }

        // åˆå§‹åŠ è¼‰
        document.addEventListener('DOMContentLoaded', function() {
            loadUnlabeledImages();
        });
    </script>
</body>
</html>